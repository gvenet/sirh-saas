<div class="admin-wrapper">
  <app-admin-navbar></app-admin-navbar>

  <nav class="page-subnav">
    <div class="subnav-content">
      <div class="subnav-left">
        <button class="subnav-back" (click)="goBack()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          Retour
        </button>
        <div class="subnav-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          @if (page) {
            <span>{{ page.name }}</span>
            <span class="page-entity-badge">{{ page.entityName }}</span>
          }
          @if (hasChanges) {
            <span class="unsaved-badge">Modifications non sauvegardées</span>
          }
        </div>
      </div>

      <div class="subnav-right">
        @if (hasChanges) {
          <button class="btn btn-secondary" (click)="cancelChanges()" [disabled]="saving">
            Annuler
          </button>
          <button class="btn btn-primary" (click)="saveAllChanges()" [disabled]="saving">
            @if (saving) {
              <span class="spinner-small"></span>
              Sauvegarde...
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
              </svg>
              Mettre à jour
            }
          </button>
        }
      </div>
    </div>
  </nav>

  <div class="editor-container">
    @if (loading) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Chargement de la page...</p>
      </div>
    }

    @if (error) {
      <div class="alert alert-error">
        {{ error }}
        <button class="alert-close" (click)="error = null">×</button>
      </div>
    }

    @if (successMessage) {
      <div class="alert alert-success">
        {{ successMessage }}
      </div>
    }

    @if (page && !loading) {
      <!-- Configuration du bouton d'ajout pour les pages LIST -->
      @if (page.pageType === PageType.LIST) {
        <div class="list-config-panel">
          <h3>Configuration de la liste</h3>
          <div class="config-row">
            <div class="form-group form-checkbox">
              <input
                type="checkbox"
                id="addButtonEnabled"
                [(ngModel)]="addButtonEnabled"
                (change)="onAddButtonConfigChange()"
              />
              <label for="addButtonEnabled">Afficher le bouton d'ajout</label>
            </div>
            @if (addButtonEnabled) {
              <div class="form-group">
                <label for="addButtonLabel">Label du bouton</label>
                <input
                  type="text"
                  id="addButtonLabel"
                  [(ngModel)]="addButtonLabel"
                  (input)="onAddButtonConfigChange()"
                  placeholder="Nouveau"
                />
              </div>
            }
          </div>
        </div>
      }

      <div class="editor-layout">
        <!-- Panneau des champs disponibles -->
        <div class="available-panel">
          <h3>Champs disponibles</h3>
          <p class="panel-hint">Glissez les champs vers la zone de droite</p>

          <div
            class="available-fields-list"
            cdkDropList
            #availableList="cdkDropList"
            [cdkDropListData]="availableFields"
            [cdkDropListConnectedTo]="[configuredList]"
            (cdkDropListDropped)="dropInAvailable($event)">

            @if (availableFields.length === 0) {
              <div class="empty-fields">
                <p>Tous les champs sont utilisés</p>
              </div>
            }

            @for (field of availableFields; track field.name) {
              <div class="available-field" cdkDrag>
                <div class="field-drag-handle" cdkDragHandle>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                  </svg>
                </div>
                <div class="field-info">
                  <span class="field-name">{{ field.name }}</span>
                  <span class="field-type" [class.is-relation]="field.isRelation">
                    @if (field.isRelation) {
                      {{ field.relationType }} → {{ field.relationTarget }}
                    } @else {
                      {{ field.type }}
                    }
                  </span>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Zone de configuration -->
        <div class="configured-panel">
          <h3>Champs de la page</h3>
          <p class="panel-hint">Réorganisez les champs et cliquez pour configurer</p>

          <div
            class="configured-fields-grid"
            cdkDropList
            #configuredList="cdkDropList"
            [cdkDropListData]="configuredFields"
            [cdkDropListConnectedTo]="[availableList]"
            (cdkDropListDropped)="dropInConfigured($event)">

            @if (configuredFields.length === 0) {
              <div class="empty-fields drop-zone">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                <p>Glissez des champs ici</p>
              </div>
            }

            @for (field of configuredFields; track field.fieldName) {
              <div
                class="configured-field"
                [class.is-new]="field.isNew"
                [style.--col-span]="field.colSpan"
                cdkDrag
                (click)="openFieldConfig(field)">

                <div class="field-drag-handle" cdkDragHandle>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                  </svg>
                </div>

                <div class="field-content">
                  <div class="field-header">
                    <span class="field-label">{{ field.label }}</span>
                    <span class="field-col-span">{{ getColSpanLabel(field.colSpan) }}</span>
                  </div>
                  <div class="field-meta">
                    <span class="field-name-small">{{ field.fieldName }}</span>
                    <span class="display-type-badge">{{ getDisplayTypeLabel(field.displayType) }}</span>
                    @if (field.isNew) {
                      <span class="new-badge">Nouveau</span>
                    }
                  </div>
                </div>

                <button class="field-config-btn" (click)="openFieldConfig(field); $event.stopPropagation()">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                  </svg>
                </button>

                <!-- Placeholder pour le drag -->
                <div class="field-placeholder" *cdkDragPlaceholder></div>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Modal de configuration -->
  @if (showFieldModal && editingField) {
    <div class="modal-overlay" (click)="closeFieldModal()">
      <div class="modal modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Configuration du champ</h3>
          <button class="modal-close" (click)="closeFieldModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Champ source</label>
              <input type="text" [value]="editingField.fieldName" disabled />
            </div>
            <div class="form-group">
              <label for="fieldLabel">Label affiché</label>
              <input
                type="text"
                id="fieldLabel"
                [(ngModel)]="fieldForm.label"
                placeholder="Label du champ"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="displayType">Type d'affichage</label>
              <select id="displayType" [(ngModel)]="fieldForm.displayType">
                <option [ngValue]="FieldDisplayType.TEXT">Texte</option>
                <option [ngValue]="FieldDisplayType.TEXTAREA">Texte long</option>
                <option [ngValue]="FieldDisplayType.NUMBER">Nombre</option>
                <option [ngValue]="FieldDisplayType.DATE">Date</option>
                <option [ngValue]="FieldDisplayType.BOOLEAN">Booléen</option>
                <option [ngValue]="FieldDisplayType.SELECT">Liste déroulante</option>
                <option [ngValue]="FieldDisplayType.TABLE">Tableau</option>
                <option [ngValue]="FieldDisplayType.HIDDEN">Masqué</option>
              </select>
            </div>
            <div class="form-group">
              <label for="colSpan">Largeur</label>
              <select id="colSpan" [(ngModel)]="fieldForm.colSpan">
                @for (option of colSpanOptions; track option.value) {
                  <option [ngValue]="option.value">{{ option.label }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-group form-checkbox">
            <input
              type="checkbox"
              id="readOnly"
              [(ngModel)]="fieldForm.readOnly"
            />
            <label for="readOnly">Lecture seule</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeFieldModal()">Annuler</button>
          <button class="btn btn-primary" (click)="saveFieldConfig()">
            Appliquer
          </button>
        </div>
      </div>
    </div>
  }
</div>
