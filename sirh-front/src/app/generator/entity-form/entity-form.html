<div class="admin-wrapper">
  <!-- Navbar Administration réutilisable -->
  <app-admin-navbar></app-admin-navbar>

  <!-- Sous-navbar pour la page -->
  <nav class="page-subnav">
    <div class="subnav-content">
      <div class="subnav-left">
        <a routerLink="/generator/list" class="subnav-back">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
          </svg>
          Retour
        </a>
        <div class="subnav-title">
          @if (isEditMode) {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
          </svg>
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
          }
          <span>{{ isEditMode ? 'Modifier' : 'Nouvelle Entité' }}</span>
          @if (isEditMode && originalEntityName) {
          <span class="entity-name-badge">{{ originalEntityName }}</span>
          }
        </div>
      </div>

      <div class="subnav-center">
        <button type="button" class="subnav-anchor" (click)="scrollTo('section-info')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
          </svg>
          Info
        </button>
        <button type="button" class="subnav-anchor" (click)="scrollTo('section-fields')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
          </svg>
          Champs
        </button>
        <button type="button" class="subnav-anchor" (click)="scrollTo('section-relations')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/>
          </svg>
          Relations
        </button>
      </div>

      <div class="subnav-right">
        <a routerLink="/generator/list" class="btn-list">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
          </svg>
          Toutes les Entités
        </a>
      </div>
    </div>
  </nav>

  <div class="entity-form-container">

    @if (error) {
    <div class="alert alert-error">
      {{ error }}
    </div>
    }

    @if (success && !waitingForRestart) {
    <div class="alert alert-success">
      {{ success }}
    </div>
    }

    @if (waitingForRestart) {
    <div class="restart-overlay">
      <div class="restart-card">
        <div class="restart-icon" [class.spinning]="restartStatus === 'checking'">
          @if (restartStatus === 'ready') {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-success">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
          </svg>
          }
        </div>
        @if (restartStatus === 'waiting') {
        <h3>Fichiers générés</h3>
        <p>Préparation du redémarrage...</p>
        } @else if (restartStatus === 'checking') {
        <h3>Redémarrage en cours</h3>
        <p>Vérification de la disponibilité du serveur...</p>
        } @else {
        <h3>Serveur prêt</h3>
        <p>Redirection vers la liste...</p>
        }
        @if (restartStatus !== 'ready') {
        <div class="restart-spinner"></div>
        }
      </div>
    </div>
    }

    <form [formGroup]="entityForm" (ngSubmit)="onSubmit()"  [class.form-disabled]="waitingForRestart">
      <div class="form-section" id="section-info">
        <h3>Entity Information</h3>

        <div class="form-group">
          <label for="name">Entity Name (PascalCase)</label>
          <input id="name" type="text" formControlName="name" placeholder="e.g., Employee" class="form-control" />
          @if (entityForm.get('name')?.invalid && entityForm.get('name')?.touched) {
          <small class="error-text">Entity name must start with uppercase letter</small>
          }
          @if (isEditMode) {
          <small class="hint-text">Le nom de l'entité ne peut pas être modifié</small>
          }
        </div>

        <div class="form-group">
          <label for="tableName">Table Name (snake_case)</label>
          <input id="tableName" type="text" formControlName="tableName" placeholder="e.g., employees"
            class="form-control" />
          @if (entityForm.get('tableName')?.invalid && entityForm.get('tableName')?.touched) {
          <small class="error-text">Table name must be in snake_case</small>
          }
          @if (isEditMode) {
          <small class="hint-text">Le nom de la table ne peut pas être modifié</small>
          }
        </div>
      </div>

      <!-- Section Champs -->
      <div class="form-section" id="section-fields">
        <div class="section-header">
          <h3>Champs</h3>
          <button type="button" class="btn btn-secondary" (click)="addField()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
            </svg>
            Ajouter Champ
          </button>
        </div>

        @if (getBasicFieldsIndices().length === 0) {
        <p class="no-fields">Aucun champ ajouté. Cliquez sur "Ajouter Champ" pour commencer.</p>
        }

        <div formArrayName="fields" class="fields-list">
          @for (idx of getBasicFieldsIndices(); track idx) {
          <div [formGroupName]="idx" class="field-card">
            <div class="field-card-header">
              <span class="field-badge field-type-badge">Champ</span>
              <span class="field-name-preview">{{ fields.at(idx).get('name')?.value || 'Nouveau champ' }}</span>
              <button type="button" class="btn-icon-remove" (click)="removeField(idx)" title="Supprimer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
              </button>
            </div>

            <div class="field-card-body">
              <div class="field-row-grid">
                <div class="form-group-inline">
                  <label>Nom</label>
                  <input type="text" formControlName="name" placeholder="nomDuChamp" class="form-control-compact" />
                </div>

                <div class="form-group-inline">
                  <label>Type</label>
                  <select formControlName="type" class="form-control-compact">
                    @for (type of basicFieldTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                    }
                  </select>
                </div>

                <div class="form-group-inline">
                  <label>Valeur par défaut</label>
                  <input type="text" formControlName="defaultValue" placeholder="Optionnel" class="form-control-compact" />
                </div>

                <div class="form-group-inline options-group">
                  <label class="checkbox-inline">
                    <input type="checkbox" formControlName="required" />
                    <span>Requis</span>
                  </label>
                  <label class="checkbox-inline">
                    <input type="checkbox" formControlName="unique" />
                    <span>Unique</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          }
        </div>
      </div>

      <!-- Section Relations -->
      <div class="form-section" id="section-relations">
        <div class="section-header">
          <h3>Relations</h3>
          <button type="button" class="btn btn-relation" (click)="addRelation()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z" />
            </svg>
            Ajouter Relation
          </button>
        </div>

        @if (getRelationFieldsIndices().length === 0) {
        <p class="no-fields">Aucune relation ajoutée. Cliquez sur "Ajouter Relation" pour lier cette entité à d'autres.</p>
        }

        <div formArrayName="fields" class="fields-list">
          @for (idx of getRelationFieldsIndices(); track idx) {
          <div [formGroupName]="idx" class="field-card relation-card">
            <div class="field-card-header">
              <span class="field-badge relation-badge">Relation</span>
              <span class="field-name-preview">{{ fields.at(idx).get('name')?.value || 'Nouvelle relation' }}</span>
              <button type="button" class="btn-icon-remove" (click)="removeField(idx)" title="Supprimer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
              </button>
            </div>

            <div class="field-card-body">
              <div class="field-row-grid">
                <div class="form-group-inline">
                  <label>Nom</label>
                  <input type="text" formControlName="name" placeholder="nomRelation" class="form-control-compact" />
                </div>

                <div class="form-group-inline">
                  <label>Type</label>
                  <select formControlName="type" class="form-control-compact">
                    @for (type of relationTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                    }
                  </select>
                </div>

                <div class="form-group-inline">
                  <label>Entité cible</label>
                  <select formControlName="relationTarget" class="form-control-compact">
                    <option value="">-- Sélectionner --</option>
                    @for (entity of availableEntities; track entity.name) {
                    <option [value]="entity.name">{{ entity.name }}</option>
                    }
                  </select>
                </div>

                <div class="form-group-inline">
                  <label>Propriété inverse</label>
                  <input type="text" formControlName="relationInverse" placeholder="ex: posts, author..." class="form-control-compact" />
                </div>

                @if (fields.at(idx).get('type')?.value === 'many-to-one' || fields.at(idx).get('type')?.value === 'one-to-one') {
                <div class="form-group-inline">
                  <label>On Delete</label>
                  <select formControlName="onDelete" class="form-control-compact">
                    <option value="SET NULL">SET NULL</option>
                    <option value="CASCADE">CASCADE</option>
                    <option value="RESTRICT">RESTRICT</option>
                    <option value="NO ACTION">NO ACTION</option>
                  </select>
                </div>
                }

                <div class="form-group-inline options-group">
                  <label class="checkbox-inline" title="Charge automatiquement cette relation à chaque requête. Déconseillé pour les listes volumineuses.">
                    <input type="checkbox" formControlName="eager" />
                    <span>Eager loading</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="help-icon">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                    </svg>
                  </label>
                </div>
              </div>
            </div>
          </div>
          }
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="entityForm.invalid || loading">
          @if (loading) {
          {{ isEditMode ? 'Updating...' : 'Generating...' }}
          } @else {
          {{ isEditMode ? 'Update Entity' : 'Generate Entity' }}
          }
        </button>
      </div>
    </form>
  </div>
</div>